<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta http-equiv="Access-Control-Allow-Origin" content="*">
    <title>聊天室Demo</title>
    <link rel="stylesheet" href="layui/css/layui.css">
	<link rel="stylesheet" href="css/main.css">
</head>
<body>
	<div class="main">
		<div class="messageBox"></div>
		<div>
		   <input type="text" id="msg" autocomplete="off" class="layui-input float-left" style=" width: 303px">
		   <button class="layui-btn float-left" onclick="sendMsg()">发送</button>
		</div>
	</div>
</body>
<script src="http://libs.baidu.com/jquery/1.8.0/jquery.min.js"></script>
<script src="layui/layui.js"></script>
<script src="js/nim/NIM_Web_NIM_v4.5.0.js"></script>
<script src="js/nim/NIM_Web_Chatroom_v4.5.0.js"></script>
<script type="text/javascript">

	//TODO 从服务器获取appkey、account、token、chatroomId
	//1.创建nim实例
	var nim = NIM.getInstance({
		debug:true,
		appKey: '0b4ad5bf42cf98254940d326bfa5aa0e',
		account: 'hr_8047914',
		token: '6eb33f755d4464000edbd03f1ea6a87e',
		onconnect: onConnect,
	});
	
	var chatroom;
	
	function onConnect(){
		//2.链接服务器成功后，再获取聊天室地址
		nim.getChatroomAddress({
			chatroomId: '19431861',
			done: getChatroomAddressDone
		});
	}
	
	function getChatroomAddressDone(error, obj) {
		console.log('获取聊天室地址' + (!error?'成功':'失败'), error, obj);
		if(!error){
			//3.获取聊天室地址成功后，初始化聊天室
			initChatroom(obj.address);
		}
	}

	function initChatroom(address){
		chatroom = Chatroom.getInstance({
			debug:true,
			appKey: '0b4ad5bf42cf98254940d326bfa5aa0e',
			account: 'hr_8047914',
			token: '6eb33f755d4464000edbd03f1ea6a87e',
			chatroomId: '19431861',
			chatroomAddresses: address,
			onconnect: onChatroomConnect,
			onerror: onChatroomError,
			onwillreconnect: onChatroomWillReconnect,
			ondisconnect: onChatroomDisconnect,
			// 消息
			onmsgs: onChatroomMsgs
		});
	}
	
	
	function onChatroomConnect(chatroom) {
		console.log('进入聊天室', chatroom);
	}
	function onChatroomWillReconnect(obj) {
		// 此时说明 `SDK` 已经断开连接, 请开发者在界面上提示用户连接已断开, 而且正在重新建立连接
		console.log('即将重连', obj);
	}
	function onChatroomDisconnect(error) {
		// 此时说明 `SDK` 处于断开状态, 开发者此时应该根据错误码提示相应的错误信息, 并且跳转到登录页面
		console.log('连接断开', error);
		if (error) {
			switch (error.code) {
			// 账号或者密码错误, 请跳转到登录页面并提示错误
			case 302:
				break;
			// 被踢, 请提示错误后跳转到登录页面
			case 'kicked':
				break;
			default:
				break;
			}
		}
	}
	function onChatroomError(error, obj) {
		console.log('发生错误', error, obj);
	}
	function onChatroomMsgs(msgs) {
		console.log('收到聊天室消息', msgs);
	}


	//发送消息
	function sendMsg(){
		var msg = $("#msg").val();
		chatroom.sendText({
		    text: msg,
		    done: sendChatroomMsgDone
		});
	}

	function sendChatroomMsgDone(error, msg) {
		console.log('发送聊天室' + msg.type + '消息' + (!error?'成功':'失败') + ', id=' + msg.idClient, error, msg);
		if(!error){
			$("#msg").val("");
		}
	}

</script>
</html>